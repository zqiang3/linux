## 概念

管道是一种最基本的IPC机制，作用于有血缘关系的进程之间。调用pipe系统函数可创建一个管道。

**特性**

1. 本质是一个伪文件（内核缓冲区）
2. 由两个文件描述符引用，一个为读端，一个为写端。
3. 数据从写端注入，从读端流出。

**局限性**

1. 数据自己读不能自己写
2. 不可反复读到，数据一旦读走就不在了
3. 半双工通信，数据只在单方向流动
4. 只能在公共祖先的进程间使用

## 原理

管道是内核使用环形队列在内核缓冲区（4k大小）实现。

## pipe

1. 父进程调用pipe函数创建管道，得到两个文件描述符，分别指向管道的读端和写端。
2. 调用fork创建子进程，子进程拥有同样的读写文件描述符
3. 父进程关闭管道读端，子进程关闭管道写端。数据从读端流入管道，从写端流出，这样就实现了进程间通信。

## 管道的读写分析

假设都是阻塞I/O操作，没有设置O_NONBLOCK标志

1. 如果所有指向管道写端的文件描述符都关闭了（管道写端引用计数为0），而仍然有进程从管道的读端读数据，那么管道中剩余的数据都被读取后，再次read会返回0，就像读到文件末尾一样。
2. 如果有指向管道写端的文件描述符没关闭（管道写端引用计数大于0），而持有管道写端的进程也没有向管道中写数据，这时有进程从管道读端读数据，那么管道中剩余的数据都被读取后，再次read会阻塞，直到管道中有数据可读了才读取数据并返回。
3. 如果所有指向管道读端的文件描述符都关闭了（管道读端引用计数为0），这时有进程向管道的写端write，那么该进程会收到信号SIGPIPE，通常会导致进程异常终止。当然也可以对SIGPIPE信号实施捕捉，不终止进程。
4. 如果有指向管道读端的文件描述符没关闭（管道读端引用计数大于0），而持有管道读端的进程也没有从管道中读数据，这时有进程向管道写端写数据，那么在管道被写满时再次write会阻塞，直到管道中有空位置了才写入数据并返回。

