## 链接

https://www.cnblogs.com/yujianfei/p/9068472.html

https://blog.csdn.net/qq_29350001/article/details/65437279

## 引言

文件描述符：** 在形式上是一个非负整数。实际上，它是一个索引值，指向内核为每一个进程所维护的该进程打开文件的记录表。 

Linux系统中把一切都看做文件，包括普通文件`-`、目录文件`d`、字符设备文件`c`、块设备文件`b`、符号链接文件`l`。文件描述符是内核为了高效管理已被打开的文件所创建的索引（一个非负整数），用于指代已被打开的文件，Linux下所有的的I/O操作的系统调用都是通过文件描述符执行。例如`0`表示标准输入、`1`表示标准输出、`3`表示标准错误 ，文件描述符会在这个基础上递增。 

## 文件描述符、文件、进程之间的关系

内核使用三种数据结构表示打开的文件，它们之间的关系决定了进程之间在文件共享时的相互影响。

（1）每个进程在进程表有一个记录项，记录项中包含一张打开的**文件描述符表**。与每个文件描述符相关联的有文件描述符标志(close_on_exec)和指向一个文件表项的指针。

（2）内核为所有打开的文件维持一张文件表。每个文件表项包含：文件状态标志（读、写、添写、同步和非阻塞等），当前文件偏移，指向文件索引节点表项的指针

（3）每个打开文件都有一个v节点结构，v节点包含了文件类型和对此文件进行各种操作的函数的指针。v节点还包含了该文件i节点（索引节点）。这些信息是在打开文件时从磁盘读入内存的。i节点包含了文件的所有者、文件长度、文件所在的设备、指向文件实际数据块在磁盘上的位置。

### 为什么设计i节点？

 i节点与文件系统类型无关。linux没有将相关数据结构分为i节点和v节点，而是采用了一个独立于文件系统的i节点和一个依赖于文件系统的i节点。

### 如果两个进程各自打开了同一个文件，文件描述符、文件表和v节点的关系是怎样的？

如果两个独立的进程各自打开了同一个文件，打开该文件的每个进程有不同的文件表项，但文件只有一个v节点项。这样做的理由是：每个进程都有它自己对该文件的偏移量。

- 
- 每个文件描述符都指向一个打开的文件相对应
- 不同的文件描述符可能指向同一个打开的文件
- 相同的文件可能被不同的进程打开，也可以在被同一个进程打开多次

**文件描述符表:** 进程级的列表，也就是用户区的一部分，进程每打开一个文件就会新建一个文件描述符，同时只能通过文件描述符的函数访问，否则进程无法直接对其进行访问。 **系统文件表:** 系统级的列表，对当前系统的所有进程都共享，每条条目包含文件偏移量、访问模式以及指向它的文件描述符的条目计数 **文件系统索引节点表：** inode索引节点表（UID、GID、ctime、mtime、atime、读写执行权限、链接数、block位置） 

## 最大文件描述符数

参见 apue_codes/check_sysconf.c 查看系统的最大打开文件描述符数。

在某些情况下文件描述符数是不够的，可根据需要进行更改

### 通过ulimit命令修改文件描述符数

ulimit 用于限制 shell 启动进程所占用的资源，支持以下各种类型的限制：所创建的内核文件的大小、进程数据块的大小、Shell 进程创建文件的大小、内存锁住的大小、常驻内存集的大小、**打开文件描述符的数量**、分配堆栈的最大大小、CPU 时间、单个用户的最大线程数、Shell 进程所能使用的最大虚拟内存。同时，它支持硬资源和软资源的限制。

**作为临时限制**，ulimit 可以作用于通过使用其命令登录的 shell 会话，在会话终止时便结束限制，并不影响于其他 shell 会话。**而对于长期的固定限制**，ulimit 命令语句又可以被添加到由登录 shell 读取的文件中，作用于特定的 shell 用户

需要注意的是ulimit提供的是对特定shell可利用的资源的控制，而shell是与具体用户相关的。因此ulimit提供的是对单个用户的限制

```bash
选项 [options]	含义	例子
-H	设置硬资源限制，一旦设置不能增加。	      ulimit – Hs 64；限制硬资源，线程栈大小为 64K。
-S	设置软资源限制，设置后可以增加，但是不能超过硬资源设置。	        ulimit – Sn 32；限制软资源，32 个文件描述符。
-a	显示当前所有的 limit 信息。	           ulimit – a；显示当前所有的 limit 信息。
-c	最大的 core 文件的大小， 以 blocks 为单位。      	ulimit – c unlimited； 对生成的 core 文件的大小不进行限制。
-d	进程最大的数据段的大小，以 Kbytes 为单位。     	ulimit -d unlimited；对进程的数据段大小不进行限制。
-f	进程可以创建文件的最大值，以 blocks 为单位。     	ulimit – f 2048；限制进程可以创建的最大文件大小为 2048 blocks。
-l	最大可加锁内存大小，以 Kbytes 为单位。       	ulimit – l 32；限制最大可加锁内存大小为 32 Kbytes。
-m	最大内存大小，以 Kbytes 为单位。       	ulimit – m unlimited；对最大内存不进行限制。
-n	可以打开最大文件描述符的数量。	       ulimit – n 128；限制最大可以使用 128 个文件描述符。
-p	管道缓冲区的大小，以 Kbytes 为单位。	      ulimit – p 512；限制管道缓冲区的大小为 512 Kbytes。
-s	线程栈大小，以 Kbytes 为单位。      	ulimit – s 512；限制线程栈的大小为 512 Kbytes。
-t	最大的 CPU 占用时间，以秒为单位。     	ulimit – t unlimited；对最大的 CPU 占用时间不进行限制。
-u	用户最大可用的进程数。     	ulimit – u 64；限制用户最多可以使用 64 个进程。
-v	进程最大可用的虚拟内存，以 Kbytes 为单位。    	ulimit – v 200000；限制最大可用的虚拟内存为 200000 Kbytes。

```

**修改当前用户环境下的最大打开文件描述符数 （临时更改）**

```bash
ulimit -HSn 1024
# 查看
ulimit -n
```

**修改文件描述符数（永久更改）**

查看原链接

**最大文件描述符数上限**

而最大文件描述符数的上限值是在 **/proc/sys/fs/nr_open** 设置的，默认为 **1048576**

**注意**

file-max 的值表示Linux内核分配的最大文件句柄数。
file-max 该文件定义了所有进程的打开文件数量的系统范围限制。（系统级）
ulimit 用于限制 shell 启动进程所占用的资源。 （进程级）
nr_open 的值表示一个进程可以分配的最大文件句柄数。 （进程级）
这也间接说明了，nr_open 是 ulimit -HSn 的上限值。

## 文件描述符和文件指针相互转换

```c
FILE* fdopen(int fd, char* type)
int fileno(FILE *stream)
```

fdopen 取一个现存的文件描述符，并使一个标准的I / O流与该描述符相结合。此函数常用于由创建管道和网络通信通道函数获得的描述符。因为这些特殊类型的文件不能用标准I/O fopen函数打开，首先必须先调用设备专用函数以获得一个文件描述符，然后用fdopen使一个标准I/O流与该描述符相结合。